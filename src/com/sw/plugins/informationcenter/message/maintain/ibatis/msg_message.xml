<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper 
    PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
    "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!-- 
   MsgID                 bigint not null auto_increment comment '消息ID',
   MsgTitle              varchar(100) comment '消息标题',
   MsgContent          text comment '消息内容',
   MsgPushDate        datetime comment '推送日期',
   MsgPusher            bigint comment '推送人ID',
   SourceID             bigint comment '来源ID',
   MsgAuditing          int comment '审核状态  1=待审核，2=审核通过，3=审核驳回 ',
   Auditor             	   bigint comment '审核人ID',
   MsgFrom               int comment '消息来源  0=系统填入，1=理财沙龙，2=研究报告，3=行业资讯，4=调查问卷 ',
   CreateTime           datetime comment 'f发布时间：消息创建的时间，以备后来跟踪查询',
   DelFlag          	    varchar(1000) comment '删除标记  0=为未删除，1=已删除 ',
 -->
<mapper namespace="message">

	<parameterMap id="message"
		type="com.sw.plugins.informationcenter.message.maintain.entity.Message" />
		
	<!-- 
	消息结果集 
	-->
	<resultMap id="messageResult"
		type="com.sw.plugins.informationcenter.message.maintain.entity.Message">
		<id property="msgId" column="MsgID" />
		<result property="msgTitle" column="MsgTitle" />
		<result property="msgContent" column="MsgContent" />
		<result property="msgPushDate" column="MsgPushDate" />
		<result property="msgPusher" column="MsgPusher" />
		<result property="sourceId" column="SourceID" />
		<result property="msgAuditing" column="MsgAuditing" />
		<result property="auditor" column="Auditor" />
		<result property="msgFrom" column="MsgFrom" />
		<result property ="published" column="CreateTime" />
		<result property="delFlag" column="DelFlag" />
		<result property="startTime" column="startTime" />
		<result property="endTime" column="endTime" />
		<result property="sourceType" column="SourceType" />
	</resultMap>
	
	<!-- 
	单一消息查询
	 -->
	<select id="selectByOne" resultMap="messageResult" parameterMap="message">
		select MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
		from MSG_Message 
		where MsgID=${msgId}
	</select>
	
	<!-- 
	消息通用查询 
	-->
	<select id="select" resultMap="messageResult" parameterMap="message">
		<if test="databaseType!=null and databaseType == 'mysql'">
			select MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
			from MSG_Message 
			<where>
				<trim prefixOverrides="and">
					<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
		 			<if test="msgId != null">and MsgID = ${msgId}</if> 
					<if test="msgTitle != null and msgTitle!='' "><![CDATA[and MsgTitle like CONCAT('%',#{msgTitle},'%')]]></if>
					<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
					<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime})]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=#{endTime}) or CreateTime like CONCAT('%',#{endTime},'%'))]]></if>
					<if test="published !=null and published !='' ">and CreateTime like CONCAT('%',#{published},'%')</if>
				</trim>
			</where>
			order by MsgID desc limit ${start},${offset}
		</if>
		<if test="databaseType!=null and databaseType == 'oracle'">
			select a.MsgID,a.MsgTitle,a.MsgContent,a.MsgPushDate,a.MsgPusher,a.SourceID,a.MsgAuditing,a.Auditor,a.MsgFrom,a.CreateTime,a.DelFlag from (	
			select t.*,ROWNUM rn from (
				select msg.* from MSG_Message msg 
				<where>
					<trim prefix="(" prefixOverrides="and" suffix=")"> 
						<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
						<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like '%'||#{msgTitle}||'%' </if>
						<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
						<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
						<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=to_date(#{startTime},'YYYY-MM-DD'))]]></if>
						<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=to_date(#{endTime},'YYYY-MM-DD')) or CreateTime like '%'||to_date(#{endTime},'YYYY-MM-DD')||'%')]]></if>
						<if test="published !=null and published !='' ">and CreateTime like '%'||to_date(#{published},'YYYY-MM-DD')||'%' </if>
					</trim>
				</where>
				order by msg.MsgID desc
			) t
			<where>
			      <if test="offset!=null and offset!=''">
			         <![CDATA[ROWNUM<=${offset}]]>
			       </if>  
		    </where>
		) a
		<where>
	      <if test="start!=null and start!=''">
	         <![CDATA[rn>=${start}]]>
	       </if>       
	    </where>					
		</if>
		<if test="databaseType!=null and databaseType == 'sqlserver'">
			select a.MsgID,a.MsgTitle,a.MsgContent,a.MsgPushDate,a.MsgPusher,a.SourceID,a.MsgAuditing,a.Auditor,a.MsgFrom,a.CreateTime,a.DelFlag from (
			select row_number() over(order by MsgID DESC) as rowNum, MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
			from MSG_Message 
			<where>
				<trim prefixOverrides="and">
					<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
					<if test="msgId != null">and MsgID = ${msgId}</if>
					<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like '%'+#{msgTitle}+'%' </if>
					<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
					<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime}+' 00:00:00.000')]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and (CreateTime<=#{endTime}+' 23:59:59.999')]]></if>
					<if test="published !=null and published !='' "><![CDATA[and (CreateTime>=#{published}+' 00:00:00.000' and CreateTime<=#{published}+' 23:59:59.999')]]></if>
				</trim>
			</where>) a
				where a.rowNum> ${start} and a.rowNum<![CDATA[<${offset}]]>
			</if>
	</select>
	
	<!-- 
	通用消息数量查询 
	-->
	<select id="selectCount" resultType="long" parameterMap="message">
		SELECT count(*) FROM MSG_Message 
		<where>
			<trim prefixOverrides="and">
				<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
				<if test="msgId != null">and MsgID = ${msgId}</if>
				<if test="msgTitle != null and msgTitle!='' ">
					<if test="databaseType!=null and databaseType == 'mysql'">
						and MsgTitle like CONCAT('%',#{msgTitle},'%')
					</if>
					<if test="databaseType!=null and databaseType == 'oracle'">
						and MsgTitle like '%'||#{msgTitle}||'%'  
					</if>
					<if test="databaseType!=null and databaseType == 'sqlserver'">
						and MsgTitle like '%'+#{msgTitle}+'%' 
					</if>
				</if>
				<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
				<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
				<if test="databaseType!=null and databaseType == 'mysql'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime})]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=#{endTime}) or CreateTime like CONCAT('%',#{endTime},'%'))]]></if>
					<if test="published !=null and published !='' ">and CreateTime like CONCAT('%',#{published},'%')</if>
				</if>
				<if test="databaseType!=null and databaseType == 'oracle'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=to_date(#{startTime},'YYYY-MM-DD'))]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=to_date(#{endTime},'YYYY-MM-DD')) or CreateTime like '%'||to_date(#{endTime},'YYYY-MM-DD')||'%')]]></if>
					<if test="published !=null and published !='' ">and CreateTime like '%'||to_date(#{published},'YYYY-MM-DD')||'%'  </if>
				</if>
				<if test="databaseType!=null and databaseType == 'sqlserver'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime}+' 00:00:00.000')]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and (CreateTime<=#{endTime}+' 23:59:59.999')]]></if>
					<if test="published !=null and published !='' "><![CDATA[and (CreateTime>=#{published}+' 00:00:00.000' and CreateTime<=#{published}+' 23:59:59.999')]]></if>
				</if>
			</trim>
		</where>
	</select>
	<!--
	 待审核消息查询
	  -->
	<select id="selectAuditing" resultMap="messageResult" parameterMap="message">
	<if test="databaseType!=null and databaseType == 'mysql'">
			select MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
			from MSG_Message 
			<where>
				<trim prefixOverrides="and">
					<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
					and msgAuditing = 1
					<if test="msgId != null">and MsgID = ${msgId}</if>
					<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like CONCAT('%',#{msgTitle},'%')</if>
					<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
					<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime})]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=#{endTime}) or CreateTime like CONCAT('%',#{endTime},'%'))]]></if>
					<if test="published !=null and published !='' ">and CreateTime like CONCAT('%',#{published},'%')</if>
				</trim>
			</where>
			order by MsgID desc limit ${start},${offset}
		</if>
		<if test="databaseType!=null and databaseType == 'oracle'">
			select a.MsgID,a.MsgTitle,a.MsgContent,a.MsgPushDate,a.MsgPusher,a.SourceID,a.MsgAuditing,a.Auditor,a.MsgFrom,a.CreateTime,a.DelFlag from (	
			select t.*,ROWNUM rn from (
				select msg.* from MSG_Message msg 
				<where>
					<trim prefix="(" prefixOverrides="and" suffix=")"> 
						<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
						and msgAuditing = 1
						<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like '%'||#{msgTitle}||'%' </if>
						<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
						<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
						<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=to_date(#{startTime},'YYYY-MM-DD'))]]></if>
						<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=to_date(#{endTime},'YYYY-MM-DD')) or CreateTime like '%'||to_date(#{endTime},'YYYY-MM-DD')||'%')]]></if>
						<if test="published !=null and published !='' ">and CreateTime like '%'||to_date(#{published},'YYYY-MM-DD')||'%' </if>
					</trim>
				</where>
				order by msg.MsgID desc
			) t
			<where>
			      <if test="offset!=null and offset!=''">
			         <![CDATA[ROWNUM<=${offset}]]>
			       </if>  
		    </where>
		) a
		<where>
	      <if test="start!=null and start!=''">
	         <![CDATA[rn>=${start}]]>
	       </if>       
	    </where>					
		</if>
		<if test="databaseType!=null and databaseType == 'sqlserver'">
			select a.MsgID,a.MsgTitle,a.MsgContent,a.MsgPushDate,a.MsgPusher,a.SourceID,a.MsgAuditing,a.Auditor,a.MsgFrom,a.CreateTime,a.DelFlag from (
			select row_number() over(order by MsgID DESC) as rowNum, MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
			from MSG_Message 
			<where>
				<trim prefixOverrides="and">
					<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
					and msgAuditing = 1
					<if test="msgId != null">and MsgID = ${msgId}</if>
					<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like '%'+#{msgTitle}+'%' </if>
					<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
					<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime}+' 00:00:00.000')]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and (CreateTime<=#{endTime}+' 23:59:59.999')]]></if>
					<if test="published !=null and published !='' "><![CDATA[and (CreateTime>=#{published}+' 00:00:00.000' and CreateTime<=#{published}+' 23:59:59.999')]]></if>
				</trim>
			</where>) a
				where a.rowNum> ${start} and a.rowNum<![CDATA[<${offset}]]>
			</if>
	</select>
	
	<!--
	 待审核消息数量查询 
	 -->
	<select id="selectAuditingCount" resultType="long" parameterMap="message">
		SELECT count(*) FROM MSG_Message 
		<where>
			<trim prefixOverrides="and">
				<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
				and msgAuditing = 1
				<if test="msgId != null">and MsgID = ${msgId}</if>
				<if test="msgTitle != null and msgTitle!='' ">
					<if test="databaseType!=null and databaseType == 'mysql'">
						and MsgTitle like CONCAT('%',#{msgTitle},'%')
					</if>
					<if test="databaseType!=null and databaseType == 'oracle'">
						and MsgTitle like '%'||#{msgTitle}||'%'  
					</if>
					<if test="databaseType!=null and databaseType == 'sqlserver'">
						and MsgTitle like '%'+#{msgTitle}+'%' 
					</if>
				</if>
				<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
				<if test="databaseType!=null and databaseType == 'mysql'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime})]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=#{endTime}) or CreateTime like CONCAT('%',#{endTime},'%'))]]></if>
					<if test="published !=null and published !='' ">and CreateTime like CONCAT('%',#{published},'%')</if>
				</if>
				<if test="databaseType!=null and databaseType == 'oracle'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=to_date(#{startTime},'YYYY-MM-DD'))]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=to_date(#{endTime},'YYYY-MM-DD')) or CreateTime like '%'||to_date(#{endTime},'YYYY-MM-DD')||'%')]]></if>
					<if test="published !=null and published !='' ">and CreateTime like '%'||to_date(#{published},'YYYY-MM-DD')||'%' </if>
				</if>
				<if test="databaseType!=null and databaseType == 'sqlserver'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime}+' 00:00:00.000')]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and (CreateTime<=#{endTime}+' 23:59:59.999')]]></if>
					<if test="published !=null and published !='' "><![CDATA[and (CreateTime>=#{published}+' 00:00:00.000' and CreateTime<=#{published}+' 23:59:59.999')]]></if>
				</if>
			</trim>
		</where>
	</select>
	
	<!-- 
	已审核消息查询
	 -->
	<select id="selectAudited" resultMap="messageResult" parameterMap="message">
		<if test="databaseType!=null and databaseType == 'mysql'">
		select MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
			from MSG_Message 
			<where>
				<trim prefixOverrides="and">
					<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
					<![CDATA[and msgAuditing <> 1]]>
					<if test="msgId != null">and MsgID = ${msgId}</if>
					<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like CONCAT('%',#{msgTitle},'%')</if>
					<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
					<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime})]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=#{endTime}) or CreateTime like CONCAT('%',#{endTime},'%'))]]></if>
					<if test="published !=null and published !='' ">and CreateTime like CONCAT('%',#{published},'%')</if>
				</trim>
			</where>
			order by MsgID desc limit ${start},${offset}
		</if>
		<if test="databaseType!=null and databaseType == 'oracle'">
			select a.MsgID,a.MsgTitle,a.MsgContent,a.MsgPushDate,a.MsgPusher,a.SourceID,a.MsgAuditing,a.Auditor,a.MsgFrom,a.CreateTime,a.DelFlag from (	
			select t.*,ROWNUM rn from (
				select msg.* from MSG_Message msg 
				<where>
					<trim prefix="(" prefixOverrides="and" suffix=")"> 
						<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
						<![CDATA[and msgAuditing <> 1]]>
						<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like '%'||#{msgTitle}||'%' </if>
						<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
						<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
						<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=to_date(#{startTime},'YYYY-MM-DD'))]]></if>
						<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=to_date(#{endTime},'YYYY-MM-DD')) or CreateTime like '%'||to_date(#{endTime},'YYYY-MM-DD')||'%')]]></if>
						<if test="published !=null and published !='' ">and CreateTime like '%'||to_date(#{published},'YYYY-MM-DD')||'%' </if>
					</trim>
				</where>
				order by msg.MsgID desc
			) t
			<where>
			      <if test="offset!=null and offset!=''">
			         <![CDATA[ROWNUM<=${offset}]]>
			       </if>  
		    </where>
		) a
		<where>
	      <if test="start!=null and start!=''">
	         <![CDATA[rn>=${start}]]>
	       </if>       
	    </where>					
		</if>
		<if test="databaseType!=null and databaseType == 'sqlserver'">
			select a.MsgID,a.MsgTitle,a.MsgContent,a.MsgPushDate,a.MsgPusher,a.SourceID,a.MsgAuditing,a.Auditor,a.MsgFrom,a.CreateTime,a.DelFlag from (
			select row_number() over(order by MsgID DESC) as rowNum, MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
			from MSG_Message 
			<where>
				<trim prefixOverrides="and">
					<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
					<![CDATA[and msgAuditing <> 1]]>
					<if test="msgId != null">and MsgID = ${msgId}</if>
					<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like '%'+#{msgTitle}+'%' </if>
					<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
					<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime}+' 00:00:00.000')]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and (CreateTime<=#{endTime}+' 23:59:59.999')]]></if>
					<if test="published !=null and published !='' "><![CDATA[and (CreateTime>=#{published}+' 00:00:00.000' and CreateTime<=#{published}+' 23:59:59.999')]]></if>
				</trim>
			</where>) a
				where a.rowNum> ${start} and a.rowNum<![CDATA[<${offset}]]>
			</if>
	</select>
	
	<!-- 
	已审核消息数量查询
	 -->
	<select id="selectAuditedCount" resultType="long" parameterMap="message">
		SELECT count(*) FROM MSG_Message 
		<where>
			<trim prefixOverrides="and">
				<![CDATA[and (DelFlag = 0 or DelFlag is null)]]>
				<![CDATA[and msgAuditing <> 1]]>
				<if test="msgId != null">and MsgID = ${msgId}</if>
				<if test="msgTitle != null and msgTitle!='' ">
					<if test="databaseType!=null and databaseType == 'mysql'">
						and MsgTitle like CONCAT('%',#{msgTitle},'%')
					</if>
					<if test="databaseType!=null and databaseType == 'oracle'">
						and MsgTitle like '%'||#{msgTitle}||'%'  
					</if>
					<if test="databaseType!=null and databaseType == 'sqlserver'">
						and MsgTitle like '%'+#{msgTitle}+'%' 
					</if>
				</if>
				<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
				<if test="databaseType!=null and databaseType == 'mysql'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime})]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=#{endTime}) or CreateTime like CONCAT('%',#{endTime},'%'))]]></if>
					<if test="published !=null and published !='' ">and CreateTime like CONCAT('%',#{published},'%')</if>
				</if>
				<if test="databaseType!=null and databaseType == 'oracle'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=to_date(#{startTime},'YYYY-MM-DD'))]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=to_date(#{endTime},'YYYY-MM-DD')) or CreateTime like '%'||to_date(#{endTime},'YYYY-MM-DD')||'%')]]></if>
					<if test="published !=null and published !='' ">and CreateTime like '%'||to_date(#{published},'YYYY-MM-DD')||'%' </if>
				</if>
				<if test="databaseType!=null and databaseType == 'sqlserver'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime}+' 00:00:00.000')]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and (CreateTime<=#{endTime}+' 23:59:59.999')]]></if>
					<if test="published !=null and published !='' "><![CDATA[and (CreateTime>=#{published}+' 00:00:00.000' and CreateTime<=#{published}+' 23:59:59.999')]]></if>
				</if>
			</trim>
		</where>
	</select>
	
	<!-- 
	消息回收站列表
	 -->
	<select id="selectRecycled" resultMap="messageResult" parameterMap="message">
	<if test="databaseType!=null and databaseType == 'mysql'">
		select MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
			from MSG_Message 
			<where>
				<trim prefixOverrides="and">
					and DelFlag = 1
					<if test="msgId != null">and MsgID = ${msgId}</if>
					<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like CONCAT('%',#{msgTitle},'%')</if>
					<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
					<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime})]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=#{endTime}) or CreateTime like CONCAT('%',#{endTime},'%'))]]></if>
					<if test="published !=null and published !='' ">and CreateTime like CONCAT('%',#{published},'%')</if>
				</trim>
			</where>
			order by MsgID desc limit ${start},${offset}
		</if>
		<if test="databaseType!=null and databaseType == 'oracle'">
			select a.MsgID,a.MsgTitle,a.MsgContent,a.MsgPushDate,a.MsgPusher,a.SourceID,a.MsgAuditing,a.Auditor,a.MsgFrom,a.CreateTime,a.DelFlag from (	
			select t.*,ROWNUM rn from (
				select msg.* from MSG_Message msg 
				<where>
					<trim prefix="(" prefixOverrides="and" suffix=")"> 
						and DelFlag = 1
						<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like '%'||#{msgTitle}||'%' </if>
						<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
						<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
						<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=to_date(#{startTime},'YYYY-MM-DD'))]]></if>
						<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=to_date(#{endTime},'YYYY-MM-DD')) or CreateTime like '%'||to_date(#{endTime},'YYYY-MM-DD')||'%')]]></if>
						<if test="published !=null and published !='' ">and CreateTime like '%'||to_date(#{published},'YYYY-MM-DD')||'%' </if>
					</trim>
				</where>
				order by msg.MsgID desc
			) t
			<where>
			      <if test="offset!=null and offset!=''">
			         <![CDATA[ROWNUM<=${offset}]]>
			       </if>  
		    </where>
		) a
		<where>
	      <if test="start!=null and start!=''">
	         <![CDATA[rn>=${start}]]>
	       </if>       
	    </where>					
		</if>
		<if test="databaseType!=null and databaseType == 'sqlserver'">
			select a.MsgID,a.MsgTitle,a.MsgContent,a.MsgPushDate,a.MsgPusher,a.SourceID,a.MsgAuditing,a.Auditor,a.MsgFrom,a.CreateTime,a.DelFlag from (
			select row_number() over(order by MsgID DESC) as rowNum, MsgID,MsgTitle,MsgContent,MsgPushDate,MsgPusher,SourceID,MsgAuditing,Auditor,MsgFrom,CreateTime,DelFlag
			from MSG_Message 
			<where>
				<trim prefixOverrides="and">
					and DelFlag = 1
					<if test="msgId != null">and MsgID = ${msgId}</if>
					<if test="msgTitle != null and msgTitle!='' ">and MsgTitle like '%'+#{msgTitle}+'%' </if>
					<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
					<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime}+' 00:00:00.000')]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and (CreateTime<=#{endTime}+' 23:59:59.999')]]></if>
					<if test="published !=null and published !='' "><![CDATA[and (CreateTime>=#{published}+' 00:00:00.000' and CreateTime<=#{published}+' 23:59:59.999')]]></if>
				</trim>
			</where>) a
				where a.rowNum> ${start} and a.rowNum<![CDATA[<${offset}]]>
			</if>
	</select>
	
	<!--
	消息回收站数量查询
	 -->
	<select id="selectRecycledCount" resultType="long" parameterMap="message">
		SELECT count(*) FROM MSG_Message 
		<where>
			<trim prefixOverrides="and">
				and DelFlag = 1
				<if test="msgId != null">and MsgID = ${msgId}</if>
				<if test="msgTitle != null and msgTitle!='' ">
					<if test="databaseType!=null and databaseType == 'mysql'">
						and MsgTitle like CONCAT('%',#{msgTitle},'%')
					</if>
					<if test="databaseType!=null and databaseType == 'oracle'">
						and MsgTitle like '%'||#{msgTitle}||'%'  
					</if>
					<if test="databaseType!=null and databaseType == 'sqlserver'">
						and MsgTitle like '%'+#{msgTitle}+'%' 
					</if>
				</if>
				<if test="msgFrom != null  and msgFrom!=0 ">and MsgFrom=${msgFrom}</if>
				<if test="msgAuditing != null  and msgAuditing!=0 ">and MsgAuditing=${msgAuditing}</if>
				<if test="databaseType!=null and databaseType == 'mysql'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime})]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ( (CreateTime<=#{endTime}) or CreateTime like CONCAT('%',#{endTime},'%'))]]></if>
					<if test="published !=null and published !='' ">and CreateTime like CONCAT('%',#{published},'%')</if>
				</if>
				<if test="databaseType!=null and databaseType == 'oracle'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=to_date(#{startTime},'YYYY-MM-DD'))]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and ((CreateTime<=to_date(#{endTime},'YYYY-MM-DD')) or CreateTime like '%'||to_date(#{endTime},'YYYY-MM-DD')||'%')]]></if>
					<if test="published !=null and published !='' ">and CreateTime like '%'||to_date(#{published},'YYYY-MM-DD')||'%' </if>
				</if>
				<if test="databaseType!=null and databaseType == 'sqlserver'">
					<if test="startTime !=null and startTime!='' "><![CDATA[and (CreateTime>=#{startTime}+' 00:00:00.000')]]></if>
					<if test="endTime !=null and endTime!='' "><![CDATA[and (CreateTime<=#{endTime}+' 23:59:59.999')]]></if>
					<if test="published !=null and published !='' "><![CDATA[and (CreateTime>=#{published}+' 00:00:00.000' and CreateTime<=#{published}+' 23:59:59.999')]]></if>
				</if>
			</trim>
		</where>
	</select>
	
	<!--
	新建消息
	 -->
	<insert id="insert" parameterMap="message">
		insert into MSG_Message 
		<trim prefix="(" prefixOverrides="," suffix=")">
		<if test="msgTitle != null ">,MsgTitle </if>
		<if test="msgContent != null">,MsgContent</if>
		<if test="sourceId != null">,SourceID</if>
		<if test="sourceType != null">,SourceType</if>
		,MsgPushDate
		,CreateTime
		,MsgFrom
		,MsgAuditing
		,DelFlag
		,Creator
		</trim>
		values
		<trim prefix="(" prefixOverrides="," suffix=")">
		<if test="msgTitle != null">,#{msgTitle}</if>
		<if test="msgContent != null">,#{msgContent}</if>
		<if test="sourceId != null">,#{sourceId}</if>
		<if test="sourceType != null">,#{sourceType}</if>
		<if test="databaseType!=null and databaseType == 'mysql'">
			,now()
		</if>
		<if test="databaseType!=null and databaseType == 'oracle'">
			,SYSDATE
		</if>
		<if test="databaseType!=null and databaseType == 'sqlserver'">
			,GETDATE()
		</if>
		<if test="databaseType!=null and databaseType == 'mysql'">
			,now()
		</if>
		<if test="databaseType!=null and databaseType == 'oracle'">
			,SYSDATE
		</if>
		<if test="databaseType!=null and databaseType == 'sqlserver'">
			,GETDATE()
		</if>
		,${msgFrom}
		,${msgAuditing}
		,0
		,#{creator}
		</trim>
	</insert>
	
	<!-- 
	更新消息
	 -->
	<update id="update" parameterMap="message">
		update MSG_Message
		<set>
			<trim prefixOverrides=",">
				<if test="msgTitle !=null and msgTitle != '' ">,MsgTitle = #{msgTitle}</if>
				<if test="msgContent !=null and msgContent !='' " >,MsgContent = #{msgContent}</if>
				<if test="msgPushDate !=null and msgPushDate !='' " >
					<if test="databaseType!=null and databaseType == 'mysql'">
						,MsgPushDate=now()
					</if>
					<if test="databaseType!=null and databaseType == 'oracle'">
						,MsgPushDate=SYSDATE
					</if>
					<if test="databaseType!=null and databaseType == 'sqlserver'">
						,MsgPushDate=GETDATE()
					</if>
				</if>
				<if test="sourceId !=null and sourceId !='' " >,SourceID = #{sourceId}</if> 
				<if test="msgAuditing !=0 and msgAuditing !='' " >,MsgAuditing = #{msgAuditing}</if>
				<if test="auditor !=null and auditor !='' " >,Auditor = #{auditor}</if>
				<if test="msgFrom !=null and msgFrom !='' " >,MsgFrom = ${msgFrom}</if>
				<if test="published !=null and published !='' " >,CreateTime = #{published}</if>
				<if test="delFlag !=0 and delFlag !='' " >,DelFlag = #{delFlag}</if>
				<if test="databaseType!=null and databaseType == 'mysql'">
					,ModifyTime=now()
				</if>
				<if test="databaseType!=null and databaseType == 'oracle'">
					,ModifyTime=SYSDATE
				</if>
				<if test="databaseType!=null and databaseType == 'sqlserver'">
					,ModifyTime=GETDATE()
				</if>
			</trim>
		</set>
		<where>
			<if test="msgId !=null and msgId !=''">
				MsgID=${msgId}
			</if>
		</where>
	</update>
	
	<!-- 
	删除消息
	 -->
	<delete id="delete" parameterMap="message">
		delete from MSG_Message where MsgID=${msgId} 
	</delete>
	
	<!-- 
	消息假删除
	 -->
	<update id="fdelete" parameterMap="message">
		update MSG_Message set DelFlag = 1 where MsgID=${msgId} 
	</update>
	<!--
	回收站消息还原
	 -->
	<update id="restore" parameterMap="message">
		update MSG_Message set DelFlag = 0 where MsgID=${msgId} 
	</update>
	
</mapper>
