<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper 
    PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
    "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!-- 
   ID                   bigint not null auto_increment comment '父机构ID：机构树状结构父节点标识',
   ParentID             bigint comment '父机构ID',
   ParentName           varbinary(255) comment '父机构名称',
   Code                 varchar(50) comment '机构代码',
   OrgLevel                int comment '所处属性菜单的级别',
   OrgPath                 varchar(200) comment '树形结构描述关系',selectOrglist
   ChildNode            int comment '子结点',
   Relation             varchar(2000) comment '父机构描述：由于机构具有树型机构的特点，要遍历树就要用递归的办法，为了提高系统数据库的查询效率，把此机构所有父机构的ID信息，以逗号相隔的方式存放在此字段，以备以后方便查询。',
   Name                 varchar(100) not null comment '机构名称：定义记录机构的名称。',
   Grade                bigint comment '机构级别',
   Phone                varchar(30) comment '机构电话：机构的联系的电话。',
   Fax                  varchar(30) comment '机构传真：机构的传真的号码。',
   PostCode             varchar(10) comment '机构邮政编码：机构所在地区的邮政编码。',
   Address              varchar(500) comment '机构地址：机构的具体的地址。',
   Description          varchar(500) comment '机构描述：机构相关信息的说明或者描述。',
   Status               bigint comment '机构状态：0.启用 1.禁用',
   CreateTime           datetime comment '创建时间：机构创建的时间，以备后来跟踪查询',
   ModifyTime           datetime comment '更新时间',
   Creator              varchar(50) comment '创建者：机构信息创建者名称的记录。',
 -->
<mapper namespace="organization">

	<parameterMap id="organization" type="com.sw.plugins.usercenter.system.organization.entity.Organization" />
		
	<parameterMap id="userOrgMapper" type="com.sw.plugins.usercenter.system.user.entity.UserOrgMapper" />
		
	<!-- 机构结果集 -->
	<resultMap id="organizationResult" type="com.sw.plugins.usercenter.system.organization.entity.Organization">
		<result property="id" column="ID" />
		<result property="level" column="OrgLevel" />
		<result property="path" column="OrgPath" />
		<result property="childNode" column="ChildNode" />
		<result property="parentId" column="ParentId" />
		<result property="parentName" column="ParentName" />
		<result property="code" column="Code" />
		<result property="name" column="Name" />
		<result property="phone" column="Phone" />
		<result property="fax" column="Fax" />
		<result property="postCode" column="PostCode" />
		<result property="address" column="Address" />
		<result property="description" column="Description" />
		<result property="createTime" column="CreateTime" />
		<result property="modifyTime" column="ModifyTime" />
		<result property="creator" column="Creator" />
	</resultMap>

	<!-- 机构通用查询 -->
	<select id="select" resultMap="organizationResult" parameterMap="organization">
		select * from UC_Organization
		<where>
			<trim prefixOverrides="and">
				<if test="id!=null">and ID=${id}</if>
				<if test="level!=null">and OrgLevel=${level}</if>
				<if test="path!=null and path!= ''">and OrgPath like '%${path}%'</if>
				<if test="childNode!=null">and ChildNode=${childNode}</if>
				<if test="parentId!=null">and ParentId=${parentId}</if>
				<if test="parentName!=null and parentName!= ''">and ParentName=#{parentName}</if>
				<if test="code!=null and code!= ''">and Code=#{code}</if>
				<if test="name!=null and name!= ''">and Name=#{name}</if>
				<if test="phone!=null and phone!= ''">and Phone=#{phone}</if>
				<if test="fax!=null and fax!= ''">and Fax=#{fax}</if>
				<if test="postCode!=null and postCode!= ''">and PostCode=#{postCode}</if>
				<if test="address!=null and address!= ''">and Address=#{address}</if>
				<if test="description!=null and description!= ''">and Description=#{description}</if>
				<if test="createTime!=null">and CreateTime=#{createTime}</if>
				<if test="modifyTime!=null">and ModifyTime=#{modifyTime}</if>
			</trim>
		</where>
	</select>

	<select id="selectSubCountByParentId" resultType="java.lang.Long" parameterMap="organization">
		select count(*) from UC_Organization
		<where>
			<trim prefixOverrides="and">
				<if test="parentId!=null">and ParentId=${parentId}</if>
			</trim>
		</where>
	</select>	

	<!-- 新增机构 -->
	<insert id="insert" parameterMap="organization">
		insert into UC_Organization
		<trim prefix="(" prefixOverrides="," suffix=")">
			<if test="level!=null">,OrgLevel</if>
			<if test="path!=null and path!= ''">,OrgPath</if>
			<if test="childNode!=null">,ChildNode</if>
			<if test="parentId!=null">,ParentId</if>
			<if test="parentName!=null and parentName!= ''">,ParentName</if>
			<if test="code!=null and code!= ''">,Code</if>
			<if test="name!=null and name!= ''">,Name</if>
			<if test="phone!=null and phone!= ''">,Phone</if>
			<if test="fax!=null and fax!= ''">,Fax</if>
			<if test="postCode!=null and postCode!= ''">,PostCode</if>
			<if test="address!=null and address!= ''">,Address</if>
			<if test="description!=null and description!= ''">,Description</if>
			<if test="createTime!=null">,CreateTime</if>
			<if test="modifyTime!=null">,ModifyTime</if>
			<if test="creator!=null">,Creator</if>
		</trim>
		values
		<trim prefix="(" prefixOverrides="," suffix=")">
			<if test="level!=null">,#{level}</if>
			<if test="path!=null and path!= ''">,#{path}</if>
			<if test="childNode!=null">,${childNode}</if>
			<if test="parentId!=null">,${parentId}</if>
			<if test="parentName!=null and parentName!= ''">,#{parentName}</if>
			<if test="code!=null and code!= ''">,#{code}</if>
			<if test="name!=null and name!= ''">,#{name}</if>
			<if test="phone!=null and phone!= ''">,#{phone}</if>
			<if test="fax!=null and fax!= ''">,#{fax}</if>
			<if test="postCode!=null and postCode!= ''">,#{postCode}</if>
			<if test="address!=null and address!= ''">,#{address}</if>
			<if test="description!=null and description!= ''">,#{description}</if>
			<if test="createTime!=null">,#{createTime}</if>
			<if test="modifyTime!=null">,#{modifyTime}</if>
			<if test="creator!=null">,${creator}</if>
		</trim>
		<selectKey keyProperty="generatedKey" resultType="Long">
			<if test="databaseType!=null and databaseType == 'mysql'">
				select LAST_INSERT_ID() as generatedKey   
			</if>
			<if test="databaseType!=null and databaseType == 'oracle'">
				SELECT S_UC_ORGANIZATION.CURRVAL AS VALUE FROM DUAL  
			</if>
			<if test="databaseType!=null and databaseType == 'sqlserver'">
				SELECT IDENT_CURRENT('UC_Organization')
			</if>
		</selectKey>		
	</insert>

	<!-- 更新机构 -->
	<update id="update" parameterMap="organization">
		update UC_Organization
		<set>
			<trim prefixOverrides=",">
				<if test="level!=null">,OrgLevel=${level}</if>
				<if test="path!=null and path!= ''">,OrgPath=#{path}</if>
				<if test="childNode!=null">,ChildNode=${childNode}</if>
				<if test="parentId!=null">,ParentId=${parentId}</if>
				<if test="parentName!=null and parentName!= ''">,ParentName=#{parentName}</if>
				<if test="code!=null and code!= ''">,Code=#{code}</if>
				<if test="name!=null and name!= ''">,Name=#{name}</if>
				<if test="phone!=null ">,Phone=#{phone}</if>
				<if test="fax!=null ">,Fax=#{fax}</if>
				<if test="postCode!=null ">,PostCode=#{postCode}</if>
				<if test="address!=null ">,Address=#{address}</if>
				<if test="description!=null ">,Description=#{description}</if>
				<if test="createTime!=null">,CreateTime=#{createTime}</if>
				<if test="modifyTime!=null">,ModifyTime=#{modifyTime}</if>
				<if test="creator!=null">,Creator=#{creator}</if>
			</trim>
		</set>
		<where>
			<if test="id!=null">
				ID=${id}
			</if>
		</where>
	</update>

	<update id="updatePath" parameterMap="organization">
		update UC_Organization
		<set>
			<trim prefixOverrides=",">
				<if test="path!=null and path!= ''">,OrgPath=#{path}</if>
			</trim>
		</set>
		<where>
			<if test="id!=null">
				ID=${id}
			</if>
		</where>
	</update>

	<!-- 删除机构 -->
	<delete id="delete" parameterMap="organization">
		delete from UC_Organization
		<where>
			<trim prefixOverrides="and">
				<if test="id!=null">and ID=${id}</if>
			</trim>
		</where>
	</delete>
	
	
	<!-- 查询用户管理的机构 -->
    <select id="selectUserOrg" resultMap="organizationResult" parameterMap="userOrgMapper">
		select 
			o.* 
		from 
			UC_UserOrgMapper uom,UC_Organization o
		<where>
			uom.OrgID = o.ID
			<if test="userID!=null">
				 and uom.UserID=${userID}
			</if>
		</where>
	</select>
	
	<!-- 查询机构下的用户-->
    <select id="selectUserCount" resultType="long" parameterMap="organization">
		select 
			count(*) 
		from 
			UC_User
		<where>
			<if test="id!=null">
				 and OrgID=${id}
			</if>
		</where>
	</select>
	
	<!-- 查询所有二级机构 -->
	<select id="selectOrglist" resultMap="organizationResult" parameterMap="organization">
		select * from UC_Organization where OrgLevel=2
	</select>
	<select id="selectThreeOrglist" resultMap="organizationResult" parameterMap="organization">
		select * from UC_Organization where OrgLevel=3
	</select>
	<select id="selectFourOrglist" resultMap="organizationResult" parameterMap="organization">
		select * from UC_Organization where OrgLevel=4
	</select>
		<select id="selectFiveOrglist" resultMap="organizationResult" parameterMap="organization">
		select * from UC_Organization where OrgLevel=5
	</select>
	
	<!-- 根据角色list查询机构 -->
	<select id="selectOrglistByRole" resultMap="organizationResult" parameterMap="organization">
		select * from UC_Organization 
		<where>
			 id in 
			 <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">  
	           	 ${item}
    		</foreach> 
		</where>
	</select>	
</mapper>
